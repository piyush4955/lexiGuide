<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LexiGuard Hackathon</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.6; background-color: #f9f9f9; color: #333;}
        h1, h3 { color: #4a4a4a; }
        .container { background-color: #fff; border: 1px solid #ddd; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden { display: none; }
        #loader { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        pre { white-space: pre-wrap; word-wrap: break-word; background-color: #f4f4f4; padding: 15px; border-radius: 5px; border: 1px solid #eee; font-family: 'Menlo', 'Consolas', monospace; font-size: 14px; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px; }
        .upload-controls { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        .analysis-section { margin-top: 25px; }
        .risk-analysis { border-left: 4px solid #d9534f; }
        .summary-analysis { border-left: 4px solid #5cb85c; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgb(0,0,0); background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; text-align: center; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>
    <h1>LexiGuard - Multilingual Document Analyzer</h1>
    <p>Select your language, document type, upload the PDF, and get a tailored analysis.</p>

    <div class="container">
        <h3>1. Configure and Upload</h3>
        <div class="upload-controls">
            <select id="language-selector">
                <option value="English">English</option>
                <option value="Hinglish">Hinglish</option>
                <option value="Hindi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                <option value="Telugu">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
                <option value="Tamil">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
                <option value="Gujarati">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</option>
            </select>
            <select id="doc-type-selector">
                <option value="Rental Agreement">Rental Agreement</option>
                <option value="Loan Contract">Loan Contract</option>
                <option value="Terms of Service">Terms of Service</option>
            </select>
            
            <!-- Combined input area -->
            <div class="bg-slate-50 border border-slate-200 rounded-xl p-6">
                <h2 class="text-xl font-semibold mb-3">2. Paste Your Text or Link</h2>
                <textarea id="combinedInput" rows="6" class="w-full rounded-lg border-2 border-slate-200 focus:border-indigo-500 focus:outline-none p-3 transition-colors duration-200 resize-none" placeholder="Enter or paste your text or a link here..."></textarea>
            </div>
        
            <input type="file" id="doc-uploader" accept=".pdf">
            <button onclick="handleAnalyze()">Analyze</button>
        </div>
    </div>

    <div id="loader" class="hidden"></div>
    
    <div id="results" class="hidden">
        <hr>
        <div class="analysis-section">
            <h3>‚úÖ Summary & Action Plan</h3>
            <pre id="summary-text" class="summary-analysis"></pre>
        </div>
        
        <div class="analysis-section">
            <h3>üö® Risk Radar</h3>
            <pre id="risk-text" class="risk-analysis"></pre>
        </div>
        
        <div class="analysis-section">
            <h3>2. Ask a Specific Question</h3>
            <input type="text" id="question-input" placeholder="e.g., What happens if I pay late?" style="width: 70%;">
            <button onclick="handleAsk()">Ask</button>
            <pre id="answer-text" style="margin-top: 10px;"></pre>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
        </div>
    </div>

    <script>
        let fullDocumentText = "";

        // Modal functions
        function showModal(title, message) {
            const modal = document.getElementById('modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            modal.style.display = 'flex';
        }

        document.querySelector('.close-btn').onclick = function() {
            document.getElementById('modal').style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('modal')) {
                document.getElementById('modal').style.display = 'none';
            }
        }

        async function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Failed to read file.'));
                reader.readAsText(file);
            });
        }

        async function handleAnalyze() {
            const uploader = document.getElementById('doc-uploader');
            const combinedInput = document.getElementById('combinedInput');
            const docTypeSelector = document.getElementById('doc-type-selector');
            const langSelector = document.getElementById('language-selector');
            const urlRegex = /^(https?|ftp):\/\/[^\s/$.?#].[^\s]*$/i;

            let sourceContent = null;
            let sourceType = null;

            // Prioritize combined input
            if (combinedInput.value.trim() !== '') {
                sourceContent = combinedInput.value.trim();
                if (urlRegex.test(sourceContent)) {
                    sourceType = 'link';
                } else {
                    sourceType = 'text';
                }
            } else if (uploader.files.length > 0) {
                // Fallback to file uploader
                sourceContent = uploader.files[0];
                sourceType = 'file';
            } else {
                showModal("Input Required", "Please provide a PDF file or text/link to analyze.");
                return;
            }

            const formData = new FormData();
            formData.append('doc_type', docTypeSelector.value);
            formData.append('language', langSelector.value);

            if (sourceType === 'file') {
                formData.append('document', sourceContent);
            } else {
                formData.append('content', sourceContent);
                formData.append('source_type', sourceType);
            }

            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');

            try {
                const response = await fetch('/analyze', { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "An unknown error occurred.");
                }

                const data = await response.json();
                fullDocumentText = data.full_text;
                document.getElementById('summary-text').textContent = data.summary_and_checklist;
                document.getElementById('risk-text').textContent = data.risk_analysis;
                document.getElementById('results').classList.remove('hidden');
            } catch (error) {
                showModal("Error", "Error: " + error.message);
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        async function handleAsk() {
            const question = document.getElementById('question-input').value;
            const langSelector = document.getElementById('language-selector');
            
            if (!question) { showModal("Question Required", "Please enter a question."); return; }
            if (!fullDocumentText) { showModal("Document Required", "Please analyze a document or text first."); return; }

            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('answer-text').textContent = "";

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        full_text: fullDocumentText,
                        question: question,
                        language: langSelector.value
                    })
                });
                if (!response.ok) throw new Error((await response.json()).error);
                
                const data = await response.json();
                document.getElementById('answer-text').textContent = data.answer;
            } catch (error) {
                showModal("Error", "Error: " + error.message);
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
